<!-- templates/players/device_logs_terminal.html - Versi贸n mejorada con persistencia -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Logs - {{ player.name }} ({{ player.device_id }})</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #0a0a0a;
            color: #00ff00;
            font-size: 13px;
            line-height: 1.2;
        }
        
        .terminal-header {
            background-color: #1a1a1a;
            padding: 8px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .terminal-title {
            color: #00ff00;
            font-weight: bold;
        }
        
        .terminal-info {
            color: #888;
            font-size: 12px;
        }
        
        .filters {
            background-color: #151515;
            padding: 8px 15px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 11px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-group label {
            color: #666;
        }
        
        .filter-group select,
        .filter-group input {
            background-color: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .auto-refresh-interval {
            background-color: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 11px;

        }

        .filter-group button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 3px 8px;
            cursor: pointer;
            font-family: monospace;
            font-size: 11px;
        }
        
        .terminal-body {
            height: calc(100vh - 100px);
            overflow-y: auto;            
            padding: 5px 0;
            background-color: #0a0a0a;
        }
        
        /* Estilo principal de los logs - UNA SOLA LNEA */
        .log-line {
            padding: 1px 15px;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            border-left: 2px solid transparent;
        }
        
        .log-line:hover {
            background-color: #1a1a1a;
        }
        
        /* Colores por nivel */
        .log-line.verbose {
            color: #666;
            border-left-color: #666;
        }
        
        .log-line.debug {
            color: #00aaff;
            border-left-color: #00aaff;
        }
        
        .log-line.info {
            color: #00ff00;
            border-left-color: #00ff00;
        }
        
        .log-line.warn {
            color: #ffaa00;
            border-left-color: #ffaa00;
        }
        
        .log-line.error {
            color: #ff4444;
            border-left-color: #ff4444;
            background-color: rgba(255, 68, 68, 0.03);
        }
        
        .log-line.fatal {
            color: #ff0066;
            border-left-color: #ff0066;
            background-color: rgba(255, 0, 102, 0.05);
        }
        
        /* Componentes de cada l铆nea */
        .log-timestamp {
            color: #888;
            margin-right: 8px;
        }
        
        .log-level-badge {
            display: inline-block;
            width: 5ch;
            text-align: center;
            margin-right: 8px;
            font-weight: bold;
        }
        
        .log-category-badge {
            display: inline-block;
            width: 14ch;
            margin-right: 8px;
            color: #aaa;
        }
        
        .log-tag {
            display: inline-block;
            width: 20ch;
            margin-right: 8px;
            color: #ffaa00;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .log-message {
            color: inherit;
        }
        
        .log-exception-indicator {
            color: #ff6666;
            margin-left: 8px;
        }
        
        .no-logs {
            text-align: center;
            color: #666;
            padding: 50px;
            font-style: italic;
        }
        
        /* Scrollbar estilo terminal */
        .terminal-body::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-body::-webkit-scrollbar-track {
            background: #111;
        }
        
        .terminal-body::-webkit-scrollbar-thumb {
            background: #444;
        }
        
        .terminal-body::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* Auto-refresh indicator */
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #666;
            margin-left: auto;
            font-size: 10px;
        }
        
        /* Status indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .status-online { background-color: #00ff00; }
        .status-offline { background-color: #666; }
        .status-error { background-color: #ff4444; }
        
        /* Responsive para m贸viles */
        @media (max-width: 768px) {
            .terminal-header {
                flex-direction: column;
                gap: 5px;
            }
            
            .filters {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .log-line {
                font-size: 11px;
                padding: 2px 10px;
            }
            
            .log-tag {
                width: 12ch;
            }
        }
    </style>
</head>
<body>
    <div class="terminal-header">
        <div class="terminal-title">
             {{ player.name }} ({{ player.device_id }})
        </div>
        <div class="terminal-info">
            <span class="status-dot status-{{ player.status }}"></span>
            {{ player.get_status_display }} | 
            Group: {{ player.group.name }} | 
            Last Sync: {{ player.last_sync|default:"Never" }}
        </div>
    </div>
    
    <div class="filters">
        <form method="GET" id="filter-form">
            <div class="filter-group">
                <label>Level:</label>
                <select name="level">
                    <option value="">All</option>
                    {% for value, label in log_levels %}
                        <option value="{{ value }}" {% if value == level_filter %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Category:</label>
                <select name="category">
                    <option value="">All</option>
                    {% for value, label in log_categories %}
                        <option value="{{ value }}" {% if value == category_filter %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Hours:</label>
                <select name="hours">
                    <option value="1" {% if hours == 1 %}selected{% endif %}>1h</option>
                    <option value="6" {% if hours == 6 %}selected{% endif %}>6h</option>
                    <option value="24" {% if hours == 24 %}selected{% endif %}>24h</option>
                    <option value="72" {% if hours == 72 %}selected{% endif %}>3d</option>
                </select>
            </div>
            
            
            
            <div class="filter-group">
                <input type="text" name="search" value="{{ search }}" placeholder="Search...">
                <button type="submit">Filter</button>
            </div>
        </form>
        
        <div class="auto-refresh">
            <input type="checkbox" id="auto-refresh">
            <label for="auto-refresh">Auto-refresh</label>
            <span id="refresh-countdown"></span>
            <label>Refresh:</label>
                <select id="refresh-interval2"  class= "auto-refresh-interval">
                    <option value="5">5s</option>
                    <option value="10">10s</option>
                    <option value="15">15s</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                    <option value="0">Manual</option>
                </select>
        </div>
    </div>
    
    <div class="terminal-body">
        {% if logs %}
            {% for log in logs %}
                <div class="log-line {{ log.level.lower }}" title="{{ log.message }}">
                    <span class="log-timestamp">{{ log.device_timestamp|date:"H:i:s" }}</span>
                    <span class="log-level-badge">{{ log.level }}</span>
                    <span class="log-category-badge">{{ log.category }}</span>
                    <span class="log-tag">{{ log.tag }}</span>
                    <span class="log-message">{{ log.message }}</span>
                    {% if log.has_exception %}
                        <span class="log-exception-indicator">[EXC]</span>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="no-logs">
                No logs found for the selected filters.
            </div>
        {% endif %}
    </div>

    <script>
        // LocalStorage keys para persistir configuraci贸n
        const STORAGE_KEY_PREFIX = 'APP_logs_';
        const STORAGE_KEY_REFRESH_INTERVAL = STORAGE_KEY_PREFIX + 'refresh_interval';
        const STORAGE_KEY_AUTO_REFRESH = STORAGE_KEY_PREFIX + 'auto_refresh';
        
        // Auto-refresh functionality with configurable interval
        let autoRefreshInterval;
        let refreshCountdown;
        let currentRefreshTime = 15; // Default 15 seconds
        let countdownTime = currentRefreshTime;
        
        const autoRefreshCheckbox = document.getElementById('auto-refresh');
        const refreshIntervalSelect = document.getElementById('refresh-interval2');
        const refreshCountdownSpan = document.getElementById('refresh-countdown');
        
        // Cargar configuraci贸n guardada
        function loadSavedSettings() {
            // Cargar intervalo de refresh
            const savedInterval = localStorage.getItem(STORAGE_KEY_REFRESH_INTERVAL);
            if (savedInterval !== null) {
                refreshIntervalSelect.value = savedInterval;
            }
            
            // Cargar estado del auto-refresh (default: true)
            const savedAutoRefresh = localStorage.getItem(STORAGE_KEY_AUTO_REFRESH);
            if (savedAutoRefresh !== null) {
                autoRefreshCheckbox.checked = savedAutoRefresh === 'true';
            } else {
                autoRefreshCheckbox.checked = true; // Default: activado
            }
        }
        
        // Guardar configuraci贸n
        function saveSettings() {
            localStorage.setItem(STORAGE_KEY_REFRESH_INTERVAL, refreshIntervalSelect.value);
            localStorage.setItem(STORAGE_KEY_AUTO_REFRESH, autoRefreshCheckbox.checked);
        }
        
        function updateCountdown() {
            if (autoRefreshCheckbox.checked && currentRefreshTime > 0) {
                refreshCountdownSpan.textContent = `(${countdownTime}s)`;
                countdownTime--;
                
                if (countdownTime < 0) {
                    countdownTime = currentRefreshTime;
                    window.location.reload();
                }
            } else {
                refreshCountdownSpan.textContent = '';
            }
        }
        
        function startAutoRefresh() {
            stopAutoRefresh();
            
            currentRefreshTime = parseInt(refreshIntervalSelect.value);
            
            if (autoRefreshCheckbox.checked && currentRefreshTime > 0) {
                countdownTime = currentRefreshTime;
                refreshCountdown = setInterval(updateCountdown, 1000);
                updateCountdown();
            }
        }
        
        function stopAutoRefresh() {
            if (refreshCountdown) {
                clearInterval(refreshCountdown);
                refreshCountdownSpan.textContent = '';
            }
        }
        
        // Event listeners
        autoRefreshCheckbox.addEventListener('change', () => {
            saveSettings();
            startAutoRefresh();
        });
        
        refreshIntervalSelect.addEventListener('change', () => {
            saveSettings();
            startAutoRefresh();
        });
        
        // Auto-submit form when filters change
        document.querySelector('select[name="level"]').addEventListener('change', () => {
            document.getElementById('filter-form').submit();
        });
        
        document.querySelector('select[name="category"]').addEventListener('change', () => {
            document.getElementById('filter-form').submit();
        });
        
        document.querySelector('select[name="hours"]').addEventListener('change', () => {
            document.getElementById('filter-form').submit();
        });
        
        // Search on Enter
        document.querySelector('input[name="search"]').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('filter-form').submit();
            }
        });
        
        // Cargar configuraci贸n guardada y empezar auto-refresh
        loadSavedSettings();
        startAutoRefresh();
        
        // Auto-scroll to bottom DESPUS de cargar la p谩gina
        window.addEventListener('load', () => {
            const terminalBody = document.querySelector('.terminal-body');
            terminalBody.scrollTop = terminalBody.scrollHeight;
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                window.location.reload();
            }
            
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.querySelector('input[name="search"]').focus();
            }
            
            // ESC para limpiar filtros
            if (e.key === 'Escape') {
                window.location.href = window.location.pathname;
            }
        });
        
        // Click to select log line (for copy/paste)
        document.querySelectorAll('.log-line').forEach(line => {
            line.addEventListener('click', () => {
                // Remove previous selections
                document.querySelectorAll('.log-line').forEach(l => l.style.backgroundColor = '');
                // Highlight selected line
                line.style.backgroundColor = '#2a2a2a';
                
                // Copy to clipboard
                const text = line.textContent;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text).then(() => {
                        // Visual feedback
                        line.style.backgroundColor = '#004400';
                        setTimeout(() => {
                            line.style.backgroundColor = '#2a2a2a';
                        }, 200);
                    });
                } else {
                    // Fallback: select text
                    if (window.getSelection) {
                        const selection = window.getSelection();
                        const range = document.createRange();
                        range.selectNodeContents(line);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
            });
        });
        
        // Mantener scroll en el bottom si ya est谩 ah铆
        const terminalBody = document.querySelector('.terminal-body');
        let isAtBottom = true;
        
        terminalBody.addEventListener('scroll', () => {
            const threshold = 50;
            isAtBottom = terminalBody.scrollTop + terminalBody.clientHeight >= terminalBody.scrollHeight - threshold;
        });
        
        // Si recibimos nuevos logs y estamos en el bottom, mantener ah铆
        const observer = new MutationObserver(() => {
            if (isAtBottom) {
                terminalBody.scrollTop = terminalBody.scrollHeight;
            }
        });
        
        // Observar cambios en el contenedor si existe
        const logsContainer = document.querySelector('.terminal-body');
        if (logsContainer) {
            observer.observe(logsContainer, {
                childList: true,
                subtree: true
            });
        }
    </script>
</body>
</html>